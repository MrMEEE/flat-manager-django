{% extends 'base.html' %}

{% block title %}{{ package.package_name }} - Flat Manager{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'flatpak:package_list' %}">Packages</a></li>
        <li class="breadcrumb-item active">{{ package.package_name }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-box-seam"></i> {{ package.package_name }}</h2>
    <div class="d-flex gap-2 align-items-center" id="action-buttons">
        {% if package.status == 'pending' %}
        <span class="badge bg-secondary">Pending</span>
        {% elif package.status == 'building' %}
        <span class="badge bg-primary">
            <span class="spinner-border spinner-border-sm me-1"></span>
            Building
        </span>
        {% elif package.status == 'publishing' %}
        <span class="badge bg-info">Publishing</span>
        {% elif package.status == 'completed' %}
        <span class="badge bg-success">Completed</span>
        {% elif package.status == 'failed' %}
        <span class="badge bg-danger">Failed</span>
        {% else %}
        <span class="badge bg-warning">{{ package.status }}</span>
        {% endif %}
        
        {% if package.status not in 'building,committing,publishing' %}
        <a href="{% url 'flatpak:package_edit' package.pk %}" class="btn btn-outline-secondary">
            <i class="bi bi-pencil"></i> Edit
        </a>
        {% endif %}
        
        {% if package.status not in 'pending,building,committing,publishing' %}
        <button type="button" class="btn btn-outline-info" onclick="retryBuild({{ package.pk }})">
            <i class="bi bi-arrow-clockwise"></i> Retry
        </button>
        {% endif %}
        
        {% if package.status in 'pending,building,committing,publishing' %}
        <button type="button" class="btn btn-outline-warning" onclick="cancelBuild({{ package.pk }})">
            <i class="bi bi-x-circle"></i> Cancel
        </button>
        {% else %}
        <a href="{% url 'flatpak:package_delete' package.pk %}" class="btn btn-outline-danger">
            <i class="bi bi-trash"></i> Delete
        </a>
        {% endif %}
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Package Details</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">Package Name:</dt>
                    <dd class="col-sm-9">{{ package.package_name }}</dd>
                    
                    <dt class="col-sm-3">Package ID:</dt>
                    <dd class="col-sm-9"><code>{{ package.package_id }}</code></dd>
                    
                    <dt class="col-sm-3">Build Number:</dt>
                    <dd class="col-sm-9" id="build-number">{{ package.build_number }}</dd>
                    
                    {% if package.version %}
                    <dt class="col-sm-3">Version:</dt>
                    <dd class="col-sm-9" id="build-version">{{ package.version }}</dd>
                    {% endif %}

                    {% if package.upstream_url %}
                    <dt class="col-sm-3">Upstream Version:</dt>
                    <dd class="col-sm-9">
                        <span id="upstream-version-value">
                            {% if package.upstream_version %}
                                {{ package.upstream_version }}
                                {% if package.version and package.upstream_version != package.version %}
                                <span class="badge bg-warning text-dark ms-1"
                                      title="Newer upstream version available">
                                    <i class="bi bi-arrow-up-circle"></i> Update available
                                </span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Not checked yet</span>
                            {% endif %}
                        </span>
                        {% if package.upstream_checked_at %}
                        <small class="text-muted ms-2" id="upstream-checked-at">
                            checked {{ package.upstream_checked_at|timesince }} ago
                        </small>
                        {% endif %}
                        <button class="btn btn-sm btn-outline-secondary ms-2" id="check-upstream-btn"
                                onclick="checkUpstreamVersion({{ package.pk }})">
                            <i class="bi bi-arrow-clockwise"></i> Check now
                        </button>
                    </dd>
                    <dt class="col-sm-3">Upstream URL:</dt>
                    <dd class="col-sm-9">
                        <a href="{{ package.upstream_url }}" target="_blank" rel="noopener">
                            {{ package.upstream_url }}
                        </a>
                    </dd>
                    {% endif %}

                    <dt class="col-sm-3">Repository:</dt>
                    <dd class="col-sm-9">
                        <a href="{% url 'flatpak:repo_detail' package.repository.pk %}">
                            {{ package.repository.name }}
                        </a>
                    </dd>
                    
                    <dt class="col-sm-3">Branch:</dt>
                    <dd class="col-sm-9"><code>{{ package.branch }}</code></dd>
                    
                    <dt class="col-sm-3">Architecture:</dt>
                    <dd class="col-sm-9">{{ package.arch }}</dd>
                    
                    <dt class="col-sm-3">Installation Type:</dt>
                    <dd class="col-sm-9">
                        <span class="badge bg-{% if package.installation_type == 'system' %}primary{% else %}info{% endif %}">
                            {{ package.installation_type|capfirst }}
                        </span>
                    </dd>
                    
                    <dt class="col-sm-3">Commit:</dt>
                    <dd class="col-sm-9"><code>{{ package.commit_hash|default:"N/A" }}</code></dd>
                    
                    {% if package.dependencies %}
                    <dt class="col-sm-3">Dependencies:</dt>
                    <dd class="col-sm-9">
                        <div class="small">
                            {% if package.dependencies.sdk %}
                            <div><strong>SDK:</strong> <code>{{ package.dependencies.sdk }}</code> 
                                {% if package.dependencies.sdk_version %}({{ package.dependencies.sdk_version }}){% endif %}
                            </div>
                            {% endif %}
                            {% if package.dependencies.runtime %}
                            <div><strong>Runtime:</strong> <code>{{ package.dependencies.runtime }}</code> 
                                {% if package.dependencies.runtime_version %}({{ package.dependencies.runtime_version }}){% endif %}
                            </div>
                            {% endif %}
                            {% if package.dependencies.base %}
                            <div><strong>Base:</strong> <code>{{ package.dependencies.base }}</code> 
                                {% if package.dependencies.base_version %}({{ package.dependencies.base_version }}){% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </dd>
                    {% endif %}
                    
                    <dt class="col-sm-3">Created By:</dt>
                    <dd class="col-sm-9">{{ package.created_by.username }}</dd>
                    
                    <dt class="col-sm-3">Created:</dt>
                    <dd class="col-sm-9">{{ package.created_at|date:"M d, Y H:i:s" }}</dd>
                    
                    {% if package.started_at %}
                    <dt class="col-sm-3">Started:</dt>
                    <dd class="col-sm-9">{{ package.started_at|date:"M d, Y H:i:s" }}</dd>
                    {% endif %}
                    
                    {% if package.completed_at %}
                    <dt class="col-sm-3">Completed:</dt>
                    <dd class="col-sm-9">{{ package.completed_at|date:"M d, Y H:i:s" }}</dd>
                    {% endif %}
                    
                    {% if package.error_message %}
                    <dt class="col-sm-3">Error:</dt>
                    <dd class="col-sm-9"><code class="text-danger">{{ package.error_message }}</code></dd>
                    {% endif %}
                </dl>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Build History</h5>
            </div>
            <div class="card-body">
                <div id="build-history-wrapper" class="table-responsive{% if not builds %} d-none{% endif %}">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Build #</th>
                                <th>Status</th>
                                <th>Version</th>
                                <th>Started</th>
                                <th>Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="build-history-tbody">
                            {% for build in builds %}
                            <tr data-build-id="{{ build.pk }}">
                                <td><strong>#{{ build.build_number }}</strong></td>
                                <td>
                                    {% if build.status == 'published' %}
                                    <span class="badge bg-success">Published</span>
                                    {% elif build.status == 'committed' %}
                                    <span class="badge bg-info">Committed</span>
                                    {% elif build.status == 'built' %}
                                    <span class="badge bg-info">Built</span>
                                    {% elif build.status == 'building' %}
                                    <span class="badge bg-primary">Building</span>
                                    {% elif build.status == 'committing' %}
                                    <span class="badge bg-primary">Committing</span>
                                    {% elif build.status == 'publishing' %}
                                    <span class="badge bg-primary">Publishing</span>
                                    {% elif build.status == 'failed' %}
                                    <span class="badge bg-danger">Failed</span>
                                    {% elif build.status == 'cancelled' %}
                                    <span class="badge bg-warning">Cancelled</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ build.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ build.version|default:"-" }}</td>
                                <td>{{ build.started_at|date:"M d, H:i" }}</td>
                                <td>
                                    {% if build.completed_at %}
                                    {{ build.completed_at|timeuntil:build.started_at }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'flatpak:build_detail' build.pk %}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                    {% if build.status == 'built' %}
                                    <button type="button" class="btn btn-sm btn-outline-info ms-1"
                                            onclick="commitBuildAction({{ package.pk }})">
                                        <i class="bi bi-check-circle"></i> Commit
                                    </button>
                                    {% elif build.status == 'committed' %}
                                    <button type="button" class="btn btn-sm btn-outline-success ms-1"
                                            onclick="publishBuildAction({{ package.pk }})">
                                        <i class="bi bi-cloud-upload"></i> Publish
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <p id="build-history-empty" class="text-muted{% if builds %} d-none{% endif %}">No builds yet. Builds will appear here when the package is built.</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Artifacts</h5>
            </div>
            <div class="card-body">
                {% if artifacts %}
                <ul class="list-unstyled">
                    {% for artifact in artifacts %}
                    <li class="mb-2">
                        <i class="bi bi-file-earmark-zip"></i>
                        <strong>{{ artifact.filename }}</strong><br>
                        <small class="text-muted">{{ artifact.file_size|filesizeformat }}</small><br>
                        <small class="text-muted">{{ artifact.checksum|truncatechars:16 }}</small>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No artifacts yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">Confirm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmModalOk">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Alert Modal -->
<div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alertModalTitle">Notice</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="alertModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const buildId = {{ package.id }};
    let buildStatus = '{{ package.status }}';
    let lastLogCount = {{ logs|length|default:0 }};
    let isAutoScrollEnabled = true;
    
    console.log('Build detail page loaded:', {buildId, buildStatus, lastLogCount});
    
    // Modal helpers
    function showConfirm(title, message, okLabel, okClass, callback) {
        document.getElementById('confirmModalTitle').textContent = title;
        document.getElementById('confirmModalBody').textContent = message;
        const okBtn = document.getElementById('confirmModalOk');
        okBtn.textContent = okLabel || 'Confirm';
        okBtn.className = 'btn ' + (okClass || 'btn-primary');
        const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
        okBtn.onclick = function() { modal.hide(); callback(); };
        modal.show();
    }
    
    function showAlert(title, message) {
        document.getElementById('alertModalTitle').textContent = title;
        document.getElementById('alertModalBody').innerHTML = message;
        const modal = new bootstrap.Modal(document.getElementById('alertModal'));
        modal.show();
    }
    
    // Check upstream version
    window.checkUpstreamVersion = async function(id) {
        const btn = document.getElementById('check-upstream-btn');
        const valueEl = document.getElementById('upstream-version-value');
        const checkedEl = document.getElementById('upstream-checked-at');
        if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>'; }
        try {
            const resp = await fetch(`/packages/${id}/check-upstream/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
                credentials: 'same-origin',
            });
            const data = await resp.json();
            if (!resp.ok) {
                showAlert('Upstream check failed', data.error || 'Unknown error');
                return;
            }
            if (valueEl) {
                let html = data.version || '<span class="text-muted">No tags found</span>';
                if (data.has_update) {
                    html += ' <span class="badge bg-warning text-dark ms-1" title="Newer upstream version available"><i class="bi bi-arrow-up-circle"></i> Update available</span>';
                }
                valueEl.innerHTML = html;
            }
            if (checkedEl) { checkedEl.textContent = 'checked just now'; }
        } catch (e) {
            showAlert('Upstream check failed', e.toString());
        } finally {
            if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Check now'; }
        }
    };

    // Retry build via AJAX
    window.retryBuild = async function(id) {
        showConfirm('Retry Build', 'Start a new build attempt for this package?', 'Retry', 'btn-info', async function() {
            try {
                const response = await fetch(`/packages/${id}/retry/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    lastLogCount = 0;
                    buildStatus = 'pending';
                    updateStatusBadge('pending');
                    updateActionButtons('pending');
                    await updateBuildDetails();
                    await refreshBuildHistory();
                    if (!window.logPollInterval) {
                        updateLogs();
                        window.logPollInterval = setInterval(updateLogs, 2000);
                    }
                } else {
                    const data = await response.json().catch(() => ({}));
                    showAlert('Error', 'Failed to retry build: ' + (data.error || response.statusText));
                }
            } catch (error) {
                console.error('Error retrying build:', error);
                showAlert('Error', 'Error retrying build: ' + error.message);
            }
        });
    };
    
    // Commit a built build from the history table
    window.commitBuildAction = async function(pkgId) {
        showConfirm('Commit Build', 'Validate this build and prepare it for publishing?', 'Commit', 'btn-info', async function() {
            try {
                const r = await fetch(`/packages/${pkgId}/commit/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });
                if (r.ok) {
                    buildStatus = 'committing';
                    updateStatusBadge('committing');
                    updateActionButtons('committing');
                    await refreshBuildHistory();
                    if (!window.logPollInterval) {
                        updateLogs();
                        window.logPollInterval = setInterval(updateLogs, 2000);
                    }
                } else {
                    const d = await r.json().catch(() => ({}));
                    showAlert('Commit Failed', d.error || r.statusText);
                }
            } catch (e) { showAlert('Error', e.message); }
        });
    };

    // Publish a committed build from the history table
    window.publishBuildAction = async function(pkgId) {
        showConfirm('Publish Build', 'Publish this build to the repository?', 'Publish', 'btn-success', async function() {
            try {
                const r = await fetch(`/packages/${pkgId}/publish/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });
                if (r.ok) {
                    buildStatus = 'publishing';
                    updateStatusBadge('publishing');
                    updateActionButtons('publishing');
                    await refreshBuildHistory();
                    if (!window.logPollInterval) {
                        updateLogs();
                        window.logPollInterval = setInterval(updateLogs, 2000);
                    }
                } else {
                    const d = await r.json().catch(() => ({}));
                    showAlert('Publish Failed', d.error || r.statusText);
                }
            } catch (e) { showAlert('Error', e.message); }
        });
    };

    // Cancel build via AJAX
    window.cancelBuild = async function(id) {
        showConfirm('Cancel Build', 'Cancel this build? The current build attempt will be stopped.', 'Cancel Build', 'btn-warning', async function() {
            try {
                const response = await fetch(`/packages/${id}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    buildStatus = 'cancelled';
                    updateStatusBadge('cancelled');
                    updateActionButtons('cancelled');
                    if (window.logPollInterval) {
                        clearInterval(window.logPollInterval);
                    }
                } else {
                    showAlert('Error', 'Failed to cancel build.', 'danger');
                }
            } catch (error) {
                console.error('Error cancelling build:', error);
                showAlert('Error', 'Error cancelling build: ' + error.message, 'danger');
            }
        });
    };
    
    // Update action buttons based on status
    function updateActionButtons(status) {
        const actionContainer = document.getElementById('action-buttons');
        if (!actionContainer) return;
        
        // Clear existing buttons (keep only badge)
        const existingButtons = actionContainer.querySelectorAll('button, a[href*=\"delete\"], a[href*=\"retry\"], a[href*=\"edit\"]');
        existingButtons.forEach(btn => btn.remove());
        
        // Determine if build is active
        const isActive = ['pending', 'building', 'committing', 'publishing'].includes(status);
        
        // Show Edit button for non-active builds
        if (!['building', 'committing', 'publishing'].includes(status)) {
            const editBtn = document.createElement('a');
            editBtn.href = `/packages/${buildId}/edit/`;
            editBtn.className = 'btn btn-outline-secondary';
            editBtn.innerHTML = '<i class=\"bi bi-pencil\"></i> Edit';
            actionContainer.appendChild(editBtn);
        }
        
        // Show Retry button for all completed/failed builds
        if (!['pending', 'building', 'committing', 'publishing'].includes(status)) {
            const retryBtn = document.createElement('button');
            retryBtn.type = 'button';
            retryBtn.className = 'btn btn-outline-info';
            retryBtn.innerHTML = '<i class=\"bi bi-arrow-clockwise\"></i> Retry';
            retryBtn.onclick = () => retryBuild(buildId);
            actionContainer.appendChild(retryBtn);
        }
        
        // Show Cancel button for active builds, Delete for others
        if (isActive) {
            const cancelBtn = document.createElement('button');
            cancelBtn.type = 'button';
            cancelBtn.className = 'btn btn-outline-warning';
            cancelBtn.innerHTML = '<i class=\"bi bi-x-circle\"></i> Cancel';
            cancelBtn.onclick = () => cancelBuild(buildId);
            actionContainer.appendChild(cancelBtn);
        } else {
            const deleteBtn = document.createElement('a');
            deleteBtn.href = `/packages/${buildId}/delete/`;
            deleteBtn.className = 'btn btn-outline-danger';
            deleteBtn.innerHTML = '<i class=\"bi bi-trash\"></i> Delete';
            actionContainer.appendChild(deleteBtn);
        }
    }
    
    // Auto-scroll logs to bottom
    const logsDiv = document.getElementById('build-logs');
    
    function scrollLogsToBottom() {
        if (logsDiv && isAutoScrollEnabled) {
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
    }
    
    // Detect manual scroll to disable auto-scroll
    if (logsDiv) {
        logsDiv.addEventListener('scroll', function() {
            const isAtBottom = logsDiv.scrollHeight - logsDiv.scrollTop <= logsDiv.clientHeight + 50;
            isAutoScrollEnabled = isAtBottom;
        });
        scrollLogsToBottom();
    }
    
    // Update build details from API
    async function updateBuildDetails() {
        try {
            const response = await fetch(`/api/builds/${buildId}/`, {
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
            
            if (!response.ok) return;
            
            const build = await response.json();
            
            // Update build number if changed
            if (build.build_number) {
                const buildNumberElement = document.getElementById('build-number');
                if (buildNumberElement) {
                    buildNumberElement.textContent = build.build_number;
                }
            }
            
            // Update version if changed
            if (build.version) {
                let versionElement = document.getElementById('build-version');
                if (versionElement) {
                    versionElement.textContent = build.version;
                } else {
                    // Create version row if it doesn't exist
                    const buildNumberRow = document.getElementById('build-number').parentElement;
                    const versionDt = document.createElement('dt');
                    versionDt.className = 'col-sm-3';
                    versionDt.textContent = 'Version:';
                    const versionDd = document.createElement('dd');
                    versionDd.className = 'col-sm-9';
                    versionDd.id = 'build-version';
                    versionDd.textContent = build.version;
                    buildNumberRow.parentElement.insertBefore(versionDt, buildNumberRow.nextSibling);
                    buildNumberRow.parentElement.insertBefore(versionDd, versionDt.nextSibling);
                }
            }
            
            // Update status badge if changed
            if (build.status !== buildStatus) {
                console.log('Status changed from', buildStatus, 'to', build.status);
                updateStatusBadge(build.status);
                updateActionButtons(build.status);
                buildStatus = build.status;
                
                // Stop polling if build is no longer active
                if (!['pending', 'building', 'committing', 'publishing'].includes(build.status)) {
                    if (window.logPollInterval) {
                        clearInterval(window.logPollInterval);
                        console.log('Build completed, stopped polling');
                    }
                }
            }
            
            // Update commit hash
            if (build.commit_hash) {
                const commitElement = document.querySelector('dd:has(+ dt:contains("Commit:"))');
                if (commitElement) {
                    const currentCommit = commitElement.querySelector('code')?.textContent;
                    if (currentCommit !== build.commit_hash) {
                        commitElement.innerHTML = `<code>${build.commit_hash}</code>`;
                    }
                }
            }
            
            // Update dependencies
            if (build.dependencies) {
                updateDependencies(build.dependencies);
            }
            
        } catch (error) {
            console.error('Error updating build details:', error);
        }
    }
    
    // Update status badge
    function updateStatusBadge(status) {
        const badgeContainer = document.querySelector('.d-flex.gap-2.align-items-center');
        if (!badgeContainer) return;
        
        const badge = badgeContainer.querySelector('.badge');
        if (!badge) return;
        
        // Remove all status classes
        badge.className = 'badge';
        
        // Add appropriate class and content based on status
        let badgeHTML = '';
        switch(status) {
            case 'pending':
                badge.classList.add('bg-secondary');
                badgeHTML = 'Pending';
                break;
            case 'building':
                badge.classList.add('bg-primary');
                badgeHTML = '<span class=\"spinner-border spinner-border-sm me-1\"></span>Building';
                break;
            case 'built':
                badge.classList.add('bg-success');
                badgeHTML = 'Built';
                break;
            case 'committing':
                badge.classList.add('bg-info');
                badgeHTML = 'Committing';
                break;
            case 'committed':
                badge.classList.add('bg-info');
                badgeHTML = 'Committed';
                break;
            case 'publishing':
                badge.classList.add('bg-info');
                badgeHTML = 'Publishing';
                break;
            case 'published':
                badge.classList.add('bg-success');
                badgeHTML = 'Published';
                break;
            case 'failed':
                badge.classList.add('bg-danger');
                badgeHTML = 'Failed';
                break;
            case 'cancelled':
                badge.classList.add('bg-warning');
                badgeHTML = 'Cancelled';
                break;
            default:
                badge.classList.add('bg-warning');
                badgeHTML = status;
        }
        badge.innerHTML = badgeHTML;
    }
    
    // Update dependencies section
    function updateDependencies(deps) {
        // Find or create dependencies section
        let depsDD = document.querySelector('dt:contains("Dependencies:")');
        if (!depsDD) return;
        
        depsDD = depsDD.nextElementSibling;
        if (!depsDD) return;
        
        let html = '<div class="small">';
        if (deps.sdk) {
            html += `<div><strong>SDK:</strong> <code>${deps.sdk}</code>`;
            if (deps.sdk_version) html += ` (${deps.sdk_version})`;
            html += '</div>';
        }
        if (deps.runtime) {
            html += `<div><strong>Runtime:</strong> <code>${deps.runtime}</code>`;
            if (deps.runtime_version) html += ` (${deps.runtime_version})`;
            html += '</div>';
        }
        if (deps.base) {
            html += `<div><strong>Base:</strong> <code>${deps.base}</code>`;
            if (deps.base_version) html += ` (${deps.base_version})`;
            html += '</div>';
        }
        html += '</div>';
        depsDD.innerHTML = html;
    }
    
    // Fetch and update logs for active builds
    async function updateLogs() {
        console.log('Fetching logs for build:', buildId);
        try {
            const response = await fetch(`/api/builds/${buildId}/logs/`, {
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
            console.log('Logs API response status:', response.status);
            
            if (!response.ok) {
                console.error('Logs API failed:', response.status, response.statusText);
                return;
            }
            
            const data = await response.json();
            
            // Handle both response formats: array (old) or object with logs key (new)
            let logsArray, apiStatus;
            if (Array.isArray(data)) {
                // Old format: direct array of logs
                logsArray = data;
                apiStatus = null;
            } else {
                // New format: object with logs, status, build_id
                logsArray = data.logs || [];
                apiStatus = data.status;
            }
            
            console.log('Logs data received:', {
                logCount: logsArray.length,
                status: apiStatus,
                lastLogCount: lastLogCount,
                isArray: Array.isArray(data)
            });
            
            // Always update if log count changed (including from 0 to some)
            if (logsArray && (logsArray.length !== lastLogCount || lastLogCount === 0)) {
                console.log('Updating logs display');
                lastLogCount = logsArray.length;
                
                // Update logs container
                if (!logsDiv) {
                    console.warn('Logs div not found');
                    return;
                }
                
                // Clear and rebuild logs
                logsDiv.innerHTML = '';
                
                if (logsArray.length === 0) {
                    // Show waiting message for active builds
                    const waiting = document.createElement('div');
                    waiting.className = 'text-muted';
                    waiting.textContent = 'Waiting for build to start...';
                    logsDiv.appendChild(waiting);
                } else {
                    logsArray.forEach(log => {
                        const logEntry = document.createElement('div');
                        logEntry.className = 'log-entry';
                        
                        let levelClass = '';
                        if (log.level === 'error') levelClass = 'text-danger';
                        else if (log.level === 'warning') levelClass = 'text-warning';
                        else if (log.level === 'info') levelClass = 'text-info';
                        
                        // Handle timestamp format (ISO string from API vs formatted time)
                        let timestamp = log.timestamp;
                        if (timestamp && timestamp.includes('T')) {
                            // Parse ISO format and extract time
                            const date = new Date(timestamp);
                            timestamp = date.toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
                        }
                        
                        logEntry.innerHTML = `
                            <span class="text-muted">${timestamp}</span>
                            <span class="${levelClass}">[${log.level.toUpperCase()}]</span>
                            ${log.message}
                        `;
                        logsDiv.appendChild(logEntry);
                    });
                    
                    scrollLogsToBottom();
                }
            }
            
            // Update build details if status might have changed
            if (apiStatus && apiStatus !== buildStatus) {
                updateBuildDetails();
            }
            
            // Also check if logs indicate completion
            if (logsArray && logsArray.length > 0) {
                const lastLog = logsArray[logsArray.length - 1];
                if (lastLog && lastLog.message && 
                    (lastLog.message.includes('completed successfully') || 
                     lastLog.message.includes('published successfully'))) {
                    // Update build details to get final status
                    setTimeout(updateBuildDetails, 1000);
                }
            }
        } catch (error) {
            console.error('Error fetching logs:', error);
        }
    }
    
    // Refresh build history table from server
    async function refreshBuildHistory() {
        try {
            const resp = await fetch(`/packages/${buildId}/builds/`, { credentials: 'same-origin' });
            if (!resp.ok) return;
            const data = await resp.json();
            const builds = data.builds || [];

            const wrapper = document.getElementById('build-history-wrapper');
            const tbody  = document.getElementById('build-history-tbody');
            const empty  = document.getElementById('build-history-empty');
            if (!wrapper || !tbody || !empty) return;

            if (builds.length === 0) {
                wrapper.classList.add('d-none');
                empty.classList.remove('d-none');
                return;
            }
            wrapper.classList.remove('d-none');
            empty.classList.add('d-none');

            const statusBadge = (status) => ({
                'published':  '<span class="badge bg-success">Published</span>',
                'committed':  '<span class="badge bg-info">Committed</span>',
                'built':      '<span class="badge bg-info">Built</span>',
                'building':   '<span class="badge bg-primary"><span class="spinner-border spinner-border-sm me-1"></span>Building</span>',
                'committing': '<span class="badge bg-primary">Committing</span>',
                'publishing': '<span class="badge bg-primary">Publishing</span>',
                'failed':     '<span class="badge bg-danger">Failed</span>',
                'cancelled':  '<span class="badge bg-warning">Cancelled</span>',
            })[status] || `<span class="badge bg-secondary">${status}</span>`;

            const knownIds = new Set(builds.map(b => String(b.id)));
            // Remove stale rows
            tbody.querySelectorAll('tr[data-build-id]').forEach(r => {
                if (!knownIds.has(r.dataset.buildId)) r.remove();
            });
            // Update or insert rows
            builds.forEach(b => {
                let row = tbody.querySelector(`tr[data-build-id="${b.id}"]`);
                const isNew = !row;
                if (isNew) { row = document.createElement('tr'); row.dataset.buildId = b.id; }
                row.innerHTML = `
                    <td><strong>#${b.build_number}</strong></td>
                    <td>${statusBadge(b.status)}</td>
                    <td>${b.version || '-'}</td>
                    <td>${b.started_at || '-'}</td>
                    <td>${b.duration || '-'}</td>
                    <td>
                        <a href="/builds/${b.id}/" class="btn btn-sm btn-outline-primary"><i class="bi bi-eye"></i> View</a>
                        ${b.status === 'built' ? `<button type="button" class="btn btn-sm btn-outline-info ms-1" onclick="commitBuildAction(${buildId})"><i class="bi bi-check-circle"></i> Commit</button>` : ''}
                        ${b.status === 'committed' ? `<button type="button" class="btn btn-sm btn-outline-success ms-1" onclick="publishBuildAction(${buildId})"><i class="bi bi-cloud-upload"></i> Publish</button>` : ''}
                    </td>
                `;
                if (isNew) {
                    // Keep newest-first order; insert before first row with a lower build_number
                    const before = [...tbody.querySelectorAll('tr')].find(
                        r => parseInt(r.querySelector('strong')?.textContent?.replace('#', '') || '0') < b.build_number
                    );
                    before ? tbody.insertBefore(row, before) : tbody.appendChild(row);
                }
            });
        } catch (err) {
            console.error('Error refreshing build history:', err);
        }
    }

    // Poll for logs if build is active
    const activeStatuses = ['pending', 'building', 'committing', 'publishing'];
    if (activeStatuses.includes(buildStatus)) {
        console.log('Build is active, starting log polling');
        // Start polling immediately, then every 2 seconds
        updateLogs();
        window.logPollInterval = setInterval(updateLogs, 2000);
    } else {
        console.log('Build is not active (status:', buildStatus, '), no polling');
    }
    
    // WebSocket handler for real-time updates
    function onWebSocketMessage(data) {
        console.log('WebSocket message received:', data);
        
        if (data.type === 'build_status_update' && data.build_id == buildId) {
            console.log('Build status update via WebSocket - updating page');
            // Update page dynamically instead of reloading
            updateBuildDetails();
            refreshBuildHistory();
        }
        
        if (data.type === 'build_log_update' && data.build_id == buildId) {
            console.log('Build log update via WebSocket:', data.log);
            
            // Add new log entry
            if (data.log && logsDiv) {
                lastLogCount++;
                
                // Remove "waiting" message if it exists
                const waitingMsg = logsDiv.querySelector('.text-muted');
                if (waitingMsg && waitingMsg.textContent.includes('Waiting')) {
                    logsDiv.innerHTML = '';
                }
                
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                let levelClass = '';
                if (data.log.level === 'error') levelClass = 'text-danger';
                else if (data.log.level === 'warning') levelClass = 'text-warning';
                else if (data.log.level === 'info') levelClass = 'text-info';
                
                logEntry.innerHTML = `
                    <span class="text-muted">${data.log.timestamp}</span>
                    <span class="${levelClass}">[${data.log.level.toUpperCase()}]</span>
                    ${data.log.message}
                `;
                logsDiv.appendChild(logEntry);
                scrollLogsToBottom();
            }
        }
    }

    // Open WebSocket for real-time push updates
    (function() {
        const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${wsScheme}://${window.location.host}/ws/builds/${buildId}/`);
        ws.onopen  = () => console.log('Build WebSocket connected, package', buildId);
        ws.onmessage = (e) => {
            try { onWebSocketMessage(JSON.parse(e.data)); }
            catch (err) { console.error('WS parse error:', err); }
        };
        ws.onclose = () => console.log('Build WebSocket disconnected');
        ws.onerror = (e) => console.error('Build WebSocket error:', e);
    })();
</script>
{% endblock %}
