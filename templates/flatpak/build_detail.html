{% extends 'base.html' %}

{% block title %}Build #{{ build.build_number }} - {{ build.package.package_name }} - Flat Manager{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'flatpak:package_list' %}">Packages</a></li>
        <li class="breadcrumb-item"><a href="{% url 'flatpak:package_detail' build.package.pk %}">{{ build.package.package_name }}</a></li>
        <li class="breadcrumb-item active">Build #{{ build.build_number }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="bi bi-hammer"></i> Build #{{ build.build_number }}
        {% if build.status == 'published' %}
        <span class="badge bg-success">Published</span>
        {% elif build.status == 'committed' %}
        <span class="badge bg-info">Committed</span>
        {% elif build.status == 'built' %}
        <span class="badge bg-info">Built</span>
        {% elif build.status == 'building' %}
        <span class="badge bg-primary">
            <span class="spinner-border spinner-border-sm me-1"></span>
            Building
        </span>
        {% elif build.status == 'committing' %}
        <span class="badge bg-primary">Committing</span>
        {% elif build.status == 'publishing' %}
        <span class="badge bg-primary">Publishing</span>
        {% elif build.status == 'failed' %}
        <span class="badge bg-danger">Failed</span>
        {% elif build.status == 'cancelled' %}
        <span class="badge bg-warning">Cancelled</span>
        {% else %}
        <span class="badge bg-secondary">{{ build.status }}</span>
        {% endif %}
    </h2>
    <div class="d-flex gap-2" id="action-buttons">
        {% if build.status == 'built' %}
        <button type="button" class="btn btn-outline-primary" id="btn-commit" onclick="commitBuild()">
            <i class="bi bi-check-circle"></i> Commit
        </button>
        {% elif build.status == 'committed' %}
        <button type="button" class="btn btn-outline-success" id="btn-publish" onclick="publishBuild()">
            <i class="bi bi-cloud-upload"></i> Publish
        </button>
        {% endif %}
        <a href="{% url 'flatpak:package_detail' build.package.pk %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Package
        </a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Build Details</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">Package:</dt>
                    <dd class="col-sm-9">
                        <a href="{% url 'flatpak:package_detail' build.package.pk %}">{{ build.package.package_name }}</a>
                        <br><small class="text-muted"><code>{{ build.package.package_id }}</code></small>
                    </dd>
                    
                    <dt class="col-sm-3">Build Number:</dt>
                    <dd class="col-sm-9"><strong>#{{ build.build_number }}</strong></dd>
                    
                    <dt class="col-sm-3">Status:</dt>
                    <dd class="col-sm-9" id="build-status">
                        {% if build.status == 'published' %}
                        <span class="badge bg-success">Published</span>
                        {% elif build.status == 'committed' %}
                        <span class="badge bg-info">Committed</span>
                        {% elif build.status == 'built' %}
                        <span class="badge bg-info">Built</span>
                        {% elif build.status == 'building' %}
                        <span class="badge bg-primary">Building</span>
                        {% elif build.status == 'committing' %}
                        <span class="badge bg-primary">Committing</span>
                        {% elif build.status == 'publishing' %}
                        <span class="badge bg-primary">Publishing</span>
                        {% elif build.status == 'failed' %}
                        <span class="badge bg-danger">Failed</span>
                        {% elif build.status == 'cancelled' %}
                        <span class="badge bg-warning">Cancelled</span>
                        {% else %}
                        <span class="badge bg-secondary">{{ build.status }}</span>
                        {% endif %}
                    </dd>
                    
                    {% if build.version %}
                    <dt class="col-sm-3">Version:</dt>
                    <dd class="col-sm-9">{{ build.version }}</dd>
                    {% endif %}
                    
                    <dt class="col-sm-3">Repository:</dt>
                    <dd class="col-sm-9">
                        <a href="{% url 'flatpak:repo_detail' build.package.repository.pk %}">
                            {{ build.package.repository.name }}
                        </a>
                    </dd>
                    
                    {% if build.source_commit %}
                    <dt class="col-sm-3">Source Commit:</dt>
                    <dd class="col-sm-9"><code>{{ build.source_commit }}</code></dd>
                    {% endif %}
                    
                    {% if build.commit_hash %}
                    <dt class="col-sm-3">OSTree Commit:</dt>
                    <dd class="col-sm-9"><code>{{ build.commit_hash }}</code></dd>
                    {% endif %}
                    
                    <dt class="col-sm-3">Started:</dt>
                    <dd class="col-sm-9">{{ build.started_at|date:"M d, Y H:i:s" }}</dd>
                    
                    {% if build.completed_at %}
                    <dt class="col-sm-3">Completed:</dt>
                    <dd class="col-sm-9">{{ build.completed_at|date:"M d, Y H:i:s" }}</dd>
                    
                    <dt class="col-sm-3">Duration:</dt>
                    <dd class="col-sm-9">{{ build.completed_at|timeuntil:build.started_at }}</dd>
                    {% endif %}
                    
                    {% if build.published_at %}
                    <dt class="col-sm-3">Published:</dt>
                    <dd class="col-sm-9">{{ build.published_at|date:"M d, Y H:i:s" }}</dd>
                    {% endif %}
                    
                    {% if build.error_message %}
                    <dt class="col-sm-3">Error:</dt>
                    <dd class="col-sm-9"><code class="text-danger">{{ build.error_message }}</code></dd>
                    {% endif %}
                </dl>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-terminal"></i> Build Logs</h5>
            </div>
            <div class="card-body">
                <div id="build-logs" style="background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 4px; max-height: 500px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.875rem;">
                    {% if logs %}
                        {% for log in logs %}
                        <div class="log-entry">
                            <span style="color: #858585;">{{ log.timestamp|date:"H:i:s" }}</span>
                            {% if log.level == 'error' %}
                            <span style="color: #f48771;">[{{ log.level|upper }}]</span>
                            {% elif log.level == 'warning' %}
                            <span style="color: #dcdcaa;">[{{ log.level|upper }}]</span>
                            {% elif log.level == 'info' %}
                            <span style="color: #4ec9b0;">[{{ log.level|upper }}]</span>
                            {% else %}
                            <span style="color: #d4d4d4;">[{{ log.level|upper }}]</span>
                            {% endif %}
                            <span style="color: #d4d4d4;">{{ log.message }}</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        {% if build.status in 'building,committing,publishing' %}
                        <div style="color: #858585;">Waiting for logs...</div>
                        {% else %}
                        <div style="color: #858585;">No logs available.</div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        {% if build.dependencies %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Dependencies</h5>
            </div>
            <div class="card-body">
                <div class="small">
                    {% if build.dependencies.sdk %}
                    <div><strong>SDK:</strong> <code>{{ build.dependencies.sdk }}</code>
                        {% if build.dependencies.sdk_version %}({{ build.dependencies.sdk_version }}){% endif %}
                    </div>
                    {% endif %}
                    {% if build.dependencies.runtime %}
                    <div><strong>Runtime:</strong> <code>{{ build.dependencies.runtime }}</code>
                        {% if build.dependencies.runtime_version %}({{ build.dependencies.runtime_version }}){% endif %}
                    </div>
                    {% endif %}
                    {% if build.dependencies.base %}
                    <div><strong>Base:</strong> <code>{{ build.dependencies.base }}</code>
                        {% if build.dependencies.base_version %}({{ build.dependencies.base_version }}){% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-arrow-up-right-circle"></i> Promotions</h5>
            </div>
            <div class="card-body" id="promotions-body">
                {% if build.status == 'published' or promotions %}
                <div class="text-muted small">Loading&hellip;</div>
                {% else %}
                <p class="text-muted mb-0">Build must be published before it can be promoted to child repositories.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const buildId = {{ build.id }};
    const packageId = {{ build.package.pk }};
    let buildStatus = '{{ build.status }}';
    let lastLogCount = {{ logs|length|default:0 }};
    
    const logsDiv = document.getElementById('build-logs');
    
    // Auto-scroll to bottom
    function scrollLogsToBottom() {
        if (logsDiv) logsDiv.scrollTop = logsDiv.scrollHeight;
    }
    scrollLogsToBottom();

    // --- Confirmation modal ---
    function showConfirm(title, message, okLabel, okClass, callback) {
        const existing = document.getElementById('_buildConfirmModal');
        if (existing) existing.remove();
        const html = `
        <div class="modal fade" id="_buildConfirmModal" tabindex="-1">
          <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">${title}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">${message}</div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn ${okClass}" id="_confirmOk">${okLabel}</button>
            </div>
          </div></div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
        const modal = new bootstrap.Modal(document.getElementById('_buildConfirmModal'));
        document.getElementById('_confirmOk').onclick = () => { modal.hide(); callback(); };
        modal.show();
    }

    // --- Error modal ---
    function showError(title, message) {
        const existing = document.getElementById('_buildErrorModal');
        if (existing) existing.remove();
        const html = `
        <div class="modal fade" id="_buildErrorModal" tabindex="-1">
          <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title text-danger"><i class="bi bi-x-octagon-fill me-2"></i>${title}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body"><div class="alert alert-danger mb-0">${message}</div></div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div></div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
        new bootstrap.Modal(document.getElementById('_buildErrorModal')).show();
    }

    // Safe JSON parse â€” never throws, always returns an object
    async function safeJson(response) {
        try { return await response.json(); } catch (_) { return {}; }
    }
    }

    // Update action buttons dynamically when status changes
    function updateActionButtons(status) {
        const container = document.getElementById('action-buttons');
        if (!container) return;
        // Remove only commit/publish buttons, keep Back button
        container.querySelectorAll('#btn-commit, #btn-publish').forEach(b => b.remove());
        const backBtn = container.querySelector('a.btn-outline-secondary');
        if (status === 'built') {
            const btn = document.createElement('button');
            btn.type = 'button'; btn.id = 'btn-commit';
            btn.className = 'btn btn-outline-primary';
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Commit';
            btn.onclick = commitBuild;
            container.insertBefore(btn, backBtn);
        } else if (status === 'committed') {
            const btn = document.createElement('button');
            btn.type = 'button'; btn.id = 'btn-publish';
            btn.className = 'btn btn-outline-success';
            btn.innerHTML = '<i class="bi bi-cloud-upload"></i> Publish';
            btn.onclick = publishBuild;
            container.insertBefore(btn, backBtn);
        }
    }

    // Update status badge in the heading
    function updateStatusBadge(status) {
        const h2 = document.querySelector('h2');
        if (!h2) return;
        const badge = h2.querySelector('.badge');
        if (!badge) return;
        const map = {
            published:  ['bg-success', 'Published'],
            committed:  ['bg-info',    'Committed'],
            built:      ['bg-info',    'Built'],
            building:   ['bg-primary', '<span class="spinner-border spinner-border-sm me-1"></span>Building'],
            committing: ['bg-primary', 'Committing'],
            publishing: ['bg-primary', 'Publishing'],
            failed:     ['bg-danger',  'Failed'],
            cancelled:  ['bg-warning', 'Cancelled'],
        };
        const [cls, html] = map[status] || ['bg-secondary', status];
        badge.className = `badge ${cls}`;
        badge.innerHTML = html;
        // Also update the status row inside Build Details card
        const statusDD = document.getElementById('build-status');
        if (statusDD) statusDD.innerHTML = `<span class="badge ${cls}">${html}</span>`;
    }

    async function commitBuild() {
        showConfirm('Commit Build', 'Validate this build and prepare it for publishing?', 'Commit', 'btn-primary', async () => {
            try {
                const r = await fetch(`/packages/${packageId}/commit/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });
                if (r.ok) {
                    buildStatus = 'committing';
                    updateStatusBadge('committing');
                    updateActionButtons('committing');
                    startPolling();
                } else {
                    const d = await safeJson(r);
                    showError('Commit Failed', d.error || r.statusText || 'Unknown error');
                }
            } catch (e) { showError('Commit Error', e.message); }
        });
    }

    async function publishBuild() {
        showConfirm('Publish Build', 'Publish this build to the repository?', 'Publish', 'btn-success', async () => {
            try {
                const r = await fetch(`/packages/${packageId}/publish/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });
                if (r.ok) {
                    buildStatus = 'publishing';
                    updateStatusBadge('publishing');
                    updateActionButtons('publishing');
                    startPolling();
                } else {
                    const d = await safeJson(r);
                    showError('Publish Failed', d.error || r.statusText || 'Unknown error');
                }
            } catch (e) { showError('Publish Error', e.message); }
        });
    }

    // Update logs via AJAX
    async function updateLogs() {
        try {
            const response = await fetch(`/api/builds/${buildId}/logs/`);
            if (!response.ok) return;
            
            const data = await response.json();
            const newLogs = data.logs || [];
            
            if (newLogs.length > lastLogCount) {
                for (let i = lastLogCount; i < newLogs.length; i++) {
                    const log = newLogs[i];
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry';
                    
                    let levelColor = '#d4d4d4';
                    if (log.level === 'error') levelColor = '#f48771';
                    else if (log.level === 'warning') levelColor = '#dcdcaa';
                    else if (log.level === 'info') levelColor = '#4ec9b0';
                    
                    const timestamp = new Date(log.timestamp).toLocaleTimeString('en-US', {hour12: false});
                    logEntry.innerHTML = `
                        <span style="color: #858585;">${timestamp}</span>
                        <span style="color: ${levelColor};">[${log.level.toUpperCase()}]</span>
                        <span style="color: #d4d4d4;">${log.message}</span>
                    `;
                    logsDiv.appendChild(logEntry);
                }
                lastLogCount = newLogs.length;
                scrollLogsToBottom();
            }
            
            // Update status if changed
            if (data.status && data.status !== buildStatus) {
                buildStatus = data.status;
                updateStatusBadge(data.status);
                updateActionButtons(data.status);
                if (data.status === 'published') {
                    const _pb = document.getElementById('promotions-body');
                    if (_pb) _pb.innerHTML = '<div class="text-muted small">Loading&hellip;</div>';
                    setTimeout(() => typeof refreshPromotions !== 'undefined' && refreshPromotions(), 500);
                }
                // Stop polling once no longer active
                if (!['building', 'committing', 'publishing'].includes(data.status)) {
                    clearInterval(window.logPollInterval);
                }
            }
        } catch (error) {
            console.error('Error fetching logs:', error);
        }
    }
    
    // Poll for logs if build is active
    const activeStatuses = ['building', 'committing', 'publishing'];

    function startPolling() {
        if (!window.logPollInterval) {
            updateLogs();
            window.logPollInterval = setInterval(updateLogs, 2000);
        }
    }

    if (activeStatuses.includes(buildStatus)) {
        startPolling();
    }

    // ========== Promotions ==========
    const buildPk = {{ build.pk }};
    let promotionPollInterval = null;

    async function refreshPromotions() {
        try {
            const resp = await fetch(`/builds/${buildPk}/promotions/`);
            if (!resp.ok) return;
            const data = await resp.json();
            renderPromotions(data);
            const hasActive = data.promotions.some(p => ['pending', 'promoting'].includes(p.status));
            if (hasActive && !promotionPollInterval) {
                promotionPollInterval = setInterval(refreshPromotions, 3000);
            } else if (!hasActive && promotionPollInterval) {
                clearInterval(promotionPollInterval);
                promotionPollInterval = null;
            }
        } catch (e) {
            console.error('Error refreshing promotions:', e);
        }
    }

    function renderPromotions(data) {
        const container = document.getElementById('promotions-body');
        if (!container) return;
        let html = '';
        if (data.promotions.length > 0) {
            html += '<table class="table table-sm mb-0"><thead><tr><th>Target Repository</th><th>Status</th><th>Promoted by</th><th>Date</th><th></th></tr></thead><tbody>';
            for (const p of data.promotions) {
                const badge = promotionStatusBadge(p.status);
                const err = p.error_message ? `<br><small class="text-danger">${p.error_message}</small>` : '';
                html += `<tr>
                    <td><strong>${p.target_repo_name}</strong></td>
                    <td>${badge}${err}</td>
                    <td>${p.promoted_by || '-'}</td>
                    <td>${p.completed_at || p.created_at}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePromotion(${p.id}, '${p.target_repo_name}')">
                            <i class="bi bi-trash3"></i>
                        </button>
                    </td>
                </tr>`;
            }
            html += '</tbody></table>';
        }
        if (data.available.length > 0) {
            if (data.promotions.length > 0) html += '<hr class="my-3">';
            html += '<div class="d-flex gap-2 flex-wrap">';
            for (const r of data.available) {
                html += `<button class="btn btn-outline-primary btn-sm" onclick="promoteToRepo(${r.id}, '${r.name}')">
                    <i class="bi bi-arrow-up-right"></i> Promote to ${r.name}
                </button>`;
            }
            html += '</div>';
        }
        if (data.promotions.length === 0 && data.available.length === 0) {
            html = '<p class="text-muted mb-0">No promotions yet and no available targets.</p>';
        }
        container.innerHTML = html;
    }

    function promotionStatusBadge(status) {
        const map = {
            pending:   '<span class="badge bg-secondary">Pending</span>',
            promoting: '<span class="badge bg-primary"><span class="spinner-border spinner-border-sm me-1"></span>Promoting...</span>',
            promoted:  '<span class="badge bg-success">Promoted</span>',
            failed:    '<span class="badge bg-danger">Failed</span>',
        };
        return map[status] || `<span class="badge bg-secondary">${status}</span>`;
    }

    async function promoteToRepo(repoId, repoName) {
        showConfirm(
            'Promote Build',
            `Promote this build to <strong>${repoName}</strong>?`,
            'Promote', 'btn-primary',
            async () => {
                try {
                    const resp = await fetch(`/builds/${buildPk}/promote/`, {
                        method: 'POST',
                        headers: {'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json'},
                        credentials: 'same-origin',
                        body: JSON.stringify({target_repo_id: repoId})
                    });
                    const data = await safeJson(resp);
                    if (resp.ok) { refreshPromotions(); }
                    else { showError('Promotion Failed', data.error || resp.statusText || 'Unknown error'); }
                } catch (e) { showError('Promotion Error', e.message); }
            }
        );
    }

    async function deletePromotion(promotionId, repoName) {
        showConfirm(
            'Remove Promotion',
            `Remove <strong>${repoName}</strong>? This will delete the app from that repository.`,
            'Remove', 'btn-danger',
            async () => {
                try {
                    const resp = await fetch(`/promotions/${promotionId}/delete/`, {
                        method: 'POST',
                        headers: {'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json'},
                        credentials: 'same-origin',
                    });
                    const data = await safeJson(resp);
                    if (resp.ok) { refreshPromotions(); }
                    else { showError('Remove Failed', data.error || resp.statusText || 'Unknown error'); }
                } catch (e) { showError('Remove Error', e.message); }
            }
        );
    }

    if (buildStatus === 'published' || {% if promotions %}true{% else %}false{% endif %}) {
        refreshPromotions();
    }

    // ========== WebSocket for real-time push updates ==========
    // The channel group is keyed on the Package PK, so use packageId here.
    (function () {
        const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${wsScheme}://${window.location.host}/ws/builds/${packageId}/`);

        ws.onopen = () => console.log('Build detail WS connected, package', packageId);

        ws.onmessage = (e) => {
            try {
                const data = JSON.parse(e.data);
                if (data.type !== 'build_status_update') return;
                // The server sends the Package PK as build_id
                if (String(data.build_id) !== String(packageId)) return;

                const newStatus = data.status;
                if (!newStatus || newStatus === buildStatus) return;

                buildStatus = newStatus;
                updateStatusBadge(newStatus);
                updateActionButtons(newStatus);

                // Kick off a log fetch so new entries appear immediately
                updateLogs();

                if (newStatus === 'published') {
                    // Reload promotions panel
                    const pb = document.getElementById('promotions-body');
                    if (pb) pb.innerHTML = '<div class="text-muted small">Loading&hellip;</div>';
                    setTimeout(refreshPromotions, 500);
                }

                if (!['building', 'committing', 'publishing'].includes(newStatus)) {
                    if (window.logPollInterval) {
                        clearInterval(window.logPollInterval);
                        window.logPollInterval = null;
                    }
                } else {
                    // Make sure polling is running for active states
                    startPolling();
                }
            } catch (err) {
                console.error('WS parse error:', err);
            }
        };

        ws.onclose = () => console.log('Build detail WS disconnected');
        ws.onerror = (err) => console.error('Build detail WS error:', err);
    })();
</script>
{% endblock %}
