{% extends 'base.html' %}

{% block title %}{{ repository.name }} - Flat Manager{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'flatpak:repo_list' %}">Repositories</a></li>
        <li class="breadcrumb-item active">{{ repository.name }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-archive"></i> {{ repository.name }}</h2>
    <div class="d-flex gap-2 align-items-center">
        <button type="button" class="btn btn-outline-secondary" id="btn-update-metadata"
                onclick="regenerateMetadata({{ repository.pk }})">
            <i class="bi bi-arrow-repeat"></i> Regenerate Metadata
        </button>
        <a href="{% url 'flatpak:repo_edit' repository.pk %}" class="btn btn-primary">
            <i class="bi bi-pencil"></i> Edit
        </a>
        <a href="{% url 'flatpak:repo_delete' repository.pk %}" class="btn btn-danger">
            <i class="bi bi-trash"></i> Delete
        </a>
        {% if repository.is_active %}
        <span class="badge bg-success">Active</span>
        {% else %}
        <span class="badge bg-secondary">Inactive</span>
        {% endif %}
    </div>
</div>

<div id="appstream-notice" class="alert alert-info alert-dismissible d-none mb-3" role="alert">
    <h6 class="alert-heading"><i class="bi bi-info-circle-fill me-1"></i> Metadata regenerated — update clients</h6>
    <p class="mb-2">The repository metadata and AppStream data have been regenerated on the server.
    Each client machine that has this remote configured needs to refresh its local AppStream cache
    before version numbers will show up in <code>flatpak remote-ls</code>.</p>
    <p class="mb-1">Run the following command on every client:</p>
    <pre class="mb-2 p-2 bg-light rounded"><code>flatpak update --appstream {{ repository.name }}</code></pre>
    <small class="text-muted">If the remote was added with a different name, replace <code>{{ repository.name }}</code> with the name used during <code>flatpak remote-add</code>.</small>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Repository Details</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">Description:</dt>
                    <dd class="col-sm-9">{{ repository.description|default:"No description" }}</dd>
                    
                    <dt class="col-sm-3">Collection ID:</dt>
                    <dd class="col-sm-9"><code>{{ repository.collection_id|default:"—" }}</code></dd>
                    
                    <dt class="col-sm-3">Repository Path:</dt>
                    <dd class="col-sm-9">
                        <code>{{ repository.repo_path }}</code>
                        {% if repository.gpg_key %}
                        <br><small class="text-muted">Public key: <code>{{ repository.get_public_key_path }}</code></small>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-3">Installation URL:</dt>
                    <dd class="col-sm-9">
                        <code>{{ request.scheme }}://{{ request.get_host }}/repositories/{{ repository.name }}</code>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('{{ request.scheme }}://{{ request.get_host }}/repositories/{{ repository.name }}')">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                        <br><small class="text-muted">Add this repository with: <code>flatpak remote-add {{ repository.name }} {{ request.scheme }}://{{ request.get_host }}/repositories/{{ repository.name }}</code></small>
                    </dd>
                    
                    <dt class="col-sm-3">GPG Key:</dt>
                    <dd class="col-sm-9">
                        {% if repository.gpg_key %}
                        <a href="{% url 'flatpak:gpgkey_detail' repository.gpg_key.pk %}">
                            <i class="bi bi-key-fill"></i> {{ repository.gpg_key.name }} ({{ repository.gpg_key.key_id }})
                        </a>
                        {% else %}
                        <span class="text-muted">No GPG key assigned</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-3">Parent Repositories:</dt>
                    <dd class="col-sm-9">
                        {% if repository.parent_repos.all %}
                        <ul class="list-unstyled mb-0">
                            {% for parent in repository.parent_repos.all %}
                            <li>
                                <a href="{% url 'flatpak:repo_detail' parent.pk %}">
                                    <i class="bi bi-arrow-up-right"></i> {{ parent.name }}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <span class="text-muted">No parent repositories</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-3">Child Repositories:</dt>
                    <dd class="col-sm-9">
                        {% if repository.child_repos.all %}
                        <ul class="list-unstyled mb-0">
                            {% for child in repository.child_repos.all %}
                            <li>
                                <a href="{% url 'flatpak:repo_detail' child.pk %}">
                                    <i class="bi bi-arrow-down-right"></i> {{ child.name }}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <span class="text-muted">No child repositories</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-3">Created By:</dt>
                    <dd class="col-sm-9">{{ repository.created_by.username }}</dd>
                    
                    <dt class="col-sm-3">Created:</dt>
                    <dd class="col-sm-9">{{ repository.created_at|date:"M d, Y H:i" }}</dd>
                    
                    <dt class="col-sm-3">Last Updated:</dt>
                    <dd class="col-sm-9">{{ repository.updated_at|date:"M d, Y H:i" }}</dd>
                </dl>
            </div>
        </div>
        
        {% if repository.subsets.all %}
        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Repository Subsets</h5>
                <a href="{% url 'flatpak:subset_create' repository.pk %}" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus-circle"></i> Add Subset
                </a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Collection ID</th>
                                <th>Base URL</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for subset in repository.subsets.all %}
                            <tr>
                                <td>{{ subset.name }}</td>
                                <td><code>{{ subset.collection_id }}</code></td>
                                <td>{{ subset.base_url|default:"—" }}</td>
                                <td>
                                    <a href="{% url 'flatpak:subset_edit' subset.pk %}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <a href="{% url 'flatpak:subset_delete' subset.pk %}" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Repository Subsets</h5>
                <a href="{% url 'flatpak:subset_create' repository.pk %}" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus-circle"></i> Add Subset
                </a>
            </div>
            <div class="card-body">
                <p class="text-muted">No subsets configured. Subsets allow you to create partial repository mirrors with different collection IDs.</p>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Statistics</h5>
            </div>
            <div class="card-body">
                <p><strong>Total Builds:</strong> {{ repository.builds.count }}</p>
                <p><strong>Active Packages:</strong> {{ repository.packages.count }}</p>
                <p><strong>Tokens:</strong> {{ repository.tokens.count }}</p>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Recent Packages</h5>
    </div>
    <div class="card-body">
        {% if repository.packages.all %}
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Package Name</th>
                        <th>Package ID</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for package in repository.packages.all|slice:":10" %}
                    <tr>
                        <td>{{ package.package_name }}</td>
                        <td><code>{{ package.package_id }}</code></td>
                        <td>
                            <span class="badge bg-{{ package.status }}">{{ package.get_status_display }}</span>
                        </td>
                        <td>{{ package.created_at|date:"M d, H:i" }}</td>
                        <td>
                            <a href="{% url 'flatpak:package_detail' package.pk %}" class="btn btn-sm btn-outline-primary">
                                View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">No packages yet</p>
        {% endif %}
    </div>
</div>

<script>
// --- Inline modal helpers ---
function _repoModal(titleHtml, bodyHtml, footerHtml) {
    const existing = document.getElementById('_repoModal');
    if (existing) existing.remove();
    document.body.insertAdjacentHTML('beforeend', `
    <div class="modal fade" id="_repoModal" tabindex="-1">
      <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header">${titleHtml}
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">${bodyHtml}</div>
        <div class="modal-footer">${footerHtml}</div>
      </div></div>
    </div>`);
    new bootstrap.Modal(document.getElementById('_repoModal')).show();
}
function showRepoError(title, message) {
    _repoModal(
        `<h5 class="modal-title text-danger"><i class="bi bi-x-octagon-fill me-2"></i>${title}</h5>`,
        `<div class="alert alert-danger mb-0">${message}</div>`,
        `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>`
    );
}
function showRepoToast(message) {
    // lightweight inline toast — no JS popup
    let t = document.getElementById('_repoToast');
    if (!t) {
        document.body.insertAdjacentHTML('beforeend',
            `<div id="_repoToast" style="position:fixed;bottom:1.5rem;right:1.5rem;z-index:9999"
                  class="toast align-items-center text-bg-success border-0" role="alert">
               <div class="d-flex">
                 <div class="toast-body" id="_repoToastBody"></div>
                 <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
               </div></div>`);
        t = document.getElementById('_repoToast');
    }
    document.getElementById('_repoToastBody').textContent = message;
    bootstrap.Toast.getOrCreateInstance(t, {delay: 2500}).show();
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text)
        .then(() => showRepoToast('URL copied to clipboard!'))
        .catch(err => showRepoError('Copy failed', err.message));
}

async function regenerateMetadata(repoId) {
    const btn = document.getElementById('btn-update-metadata');
    const origHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Regenerating…';
    try {
        const r = await fetch(`/repos/${repoId}/update-metadata/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            credentials: 'same-origin'
        });
        let d = {};
        try { d = await r.json(); } catch (_) {}
        if (d.status === 'ok') {
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-outline-success');
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Done';
            const notice = document.getElementById('appstream-notice');
            if (notice) {
                notice.classList.remove('d-none');
                notice.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        } else {
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-outline-warning');
            btn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Partial';
            const msg = (d.message || 'Warning') + (d.detail ? '<br><code>' + d.detail + '</code>' : '');
            showRepoError('Metadata update warning', msg);
        }
    } catch (e) {
        btn.classList.add('btn-outline-danger');
        btn.innerHTML = '<i class="bi bi-x-circle"></i> Failed';
        showRepoError('Request failed', e.message);
    } finally {
        btn.disabled = false;
        setTimeout(() => {
            btn.className = btn.className.replace(/btn-outline-(success|warning|danger)/, 'btn-outline-secondary');
            btn.innerHTML = origHtml;
        }, 4000);
    }
}
</script>
{% endblock %}
