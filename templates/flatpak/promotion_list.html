{% extends 'base.html' %}

{% block title %}Published Builds{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-arrow-up-right-circle"></i> Published Builds</h2>
</div>

<div class="card mb-3">
    <div class="card-body">
        <form id="filter-form" method="get" class="row g-2 align-items-end">
            <div class="col-sm-4">
                <label class="form-label small text-muted mb-1">Search package</label>
                <input type="text" name="q" value="{{ filter_q }}" class="form-control form-control-sm"
                       placeholder="Package name or IDâ€¦" autocomplete="off">
            </div>
            <div class="col-12"><hr class="my-1"><small class="text-muted">Published Builds filters</small></div>
            <div class="col-sm-3">
                <label class="form-label small text-muted mb-1">Source repository</label>
                <select name="pub_repo" class="form-select form-select-sm">
                    <option value="">All repos</option>
                    {% for repo in repositories %}
                    <option value="{{ repo.pk }}" {% if filter_pub_repo == repo.pk|stringformat:"s" %}selected{% endif %}>{{ repo.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12"><hr class="my-1"><small class="text-muted">Promotions filters</small></div>
            <div class="col-sm-3">
                <label class="form-label small text-muted mb-1">Promotion status</label>
                <select name="status" class="form-select form-select-sm">
                    <option value="">All statuses</option>
                    {% for val, label in promo_status_choices %}
                    <option value="{{ val }}" {% if filter_status == val %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-sm-3">
                <label class="form-label small text-muted mb-1">Promoted to</label>
                <select name="repo" class="form-select form-select-sm">
                    <option value="">All repos</option>
                    {% for repo in repositories %}
                    <option value="{{ repo.pk }}" {% if filter_repo == repo.pk|stringformat:"s" %}selected{% endif %}>{{ repo.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto align-self-end">
                <a id="clear-btn" href="{% url 'flatpak:promotion_list' %}" class="btn btn-sm btn-outline-secondary"
                   {% if not filter_q and not filter_status and not filter_repo and not filter_pub_repo %}style="display:none"{% endif %}>
                    <i class="bi bi-x-lg"></i> Clear
                </a>
            </div>
        </form>
    </div>
</div>

<div id="results-container">
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-cloud-upload"></i> Published to Build Repository</h5>
    </div>
    <div class="card-body p-0">
        {% if published_builds %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Build</th>
                        <th>Package</th>
                        <th>Version</th>
                        <th>Repository</th>
                        <th>Status</th>
                        <th>Published</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for build in published_builds %}
                    <tr>
                        <td><a href="{% url 'flatpak:build_detail' build.pk %}">#{{ build.build_number }}</a></td>
                        <td>
                            <a href="{% url 'flatpak:package_detail' build.package.pk %}">{{ build.package.package_name }}</a>
                            <br><small class="text-muted"><code>{{ build.package.package_id }}</code></small>
                        </td>
                        <td>{{ build.version|default:"-" }}</td>
                        <td>
                            <a href="{% url 'flatpak:repo_detail' build.package.repository.pk %}">{{ build.package.repository.name }}</a>
                        </td>
                        <td><span class="badge bg-success">Published</span></td>
                        <td>{{ build.completed_at|date:"M d, H:i"|default:"-" }}</td>
                        <td>
                            <a href="{% url 'flatpak:build_detail' build.pk %}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-danger ms-1"
                                    onclick="confirmUnpublish({{ build.pk }}, '{{ build.package.package_name|escapejs }}', '#{{ build.build_number }}')">
                                <i class="bi bi-trash3"></i> Unpublish
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-3 text-muted">No published builds yet.</div>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-arrow-up-right"></i> Promotions to Child Repositories</h5>
    </div>
    <div class="card-body p-0">
        {% if promotions %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Build</th>
                        <th>Package</th>
                        <th>Version</th>
                        <th>Source Repo</th>
                        <th>Promoted To</th>
                        <th>Status</th>
                        <th>Promoted by</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for promotion in promotions %}
                    <tr>
                        <td>
                            <a href="{% url 'flatpak:build_detail' promotion.build.pk %}">#{{ promotion.build.build_number }}</a>
                        </td>
                        <td>
                            <a href="{% url 'flatpak:package_detail' promotion.package.pk %}">{{ promotion.package.package_name }}</a>
                            <br><small class="text-muted"><code>{{ promotion.package.package_id }}</code></small>
                        </td>
                        <td>{{ promotion.build.version|default:"-" }}</td>
                        <td>
                            <a href="{% url 'flatpak:repo_detail' promotion.package.repository.pk %}">
                                {{ promotion.package.repository.name }}
                            </a>
                        </td>
                        <td>
                            <a href="{% url 'flatpak:repo_detail' promotion.target_repo.pk %}">
                                {{ promotion.target_repo.name }}
                            </a>
                        </td>
                        <td>
                            {% if promotion.status == 'promoted' %}
                            <span class="badge bg-success">Promoted</span>
                            {% elif promotion.status == 'promoting' %}
                            <span class="badge bg-primary">
                                <span class="spinner-border spinner-border-sm me-1"></span>Promoting
                            </span>
                            {% elif promotion.status == 'pending' %}
                            <span class="badge bg-secondary">Pending</span>
                            {% elif promotion.status == 'failed' %}
                            <span class="badge bg-danger">Failed</span>
                            {% if promotion.error_message %}
                            <br><small class="text-danger">{{ promotion.error_message|truncatechars:80 }}</small>
                            {% endif %}
                            {% endif %}
                        </td>
                        <td>{{ promotion.promoted_by.username|default:"-" }}</td>
                        <td>
                            {% if promotion.completed_at %}
                            {{ promotion.completed_at|date:"M d, H:i" }}
                            {% else %}
                            {{ promotion.created_at|date:"M d, H:i" }}
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'flatpak:build_detail' promotion.build.pk %}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i>
                            </a>
                            {% if promotion.status == 'promoted' %}
                            <button class="btn btn-sm btn-outline-danger ms-1"
                                    onclick="confirmDeletePromotion({{ promotion.pk }}, '{{ promotion.package.package_name|escapejs }}', '{{ promotion.target_repo.name|escapejs }}')">
                                <i class="bi bi-trash3"></i> Delete
                            </button>
                            {% elif promotion.status == 'failed' %}
                            <button class="btn btn-sm btn-outline-secondary ms-1"
                                    onclick="confirmDeletePromotion({{ promotion.pk }}, '{{ promotion.package.package_name|escapejs }}', '{{ promotion.target_repo.name|escapejs }}')">
                                <i class="bi bi-x-circle"></i> Dismiss
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if is_paginated %}
        <div class="p-3">
            <nav>
                <ul class="pagination justify-content-center mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item"><a class="page-link" href="?{% if filter_params %}{{ filter_params }}&{% endif %}page=1">First</a></li>
                    <li class="page-item"><a class="page-link" href="?{% if filter_params %}{{ filter_params }}&{% endif %}page={{ page_obj.previous_page_number }}">Previous</a></li>
                    {% endif %}
                    <li class="page-item active">
                        <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                    </li>
                    {% if page_obj.has_next %}
                    <li class="page-item"><a class="page-link" href="?{% if filter_params %}{{ filter_params }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a></li>
                    <li class="page-item"><a class="page-link" href="?{% if filter_params %}{{ filter_params }}&{% endif %}page={{ page_obj.paginator.num_pages }}">Last</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}

        {% else %}
        <div class="p-3 text-muted">No promotions yet. Publish a build and promote it to a child repository.</div>
        {% endif %}
    </div>
</div>
</div>
<script>
(function () {
    var form = document.getElementById('filter-form');
    var container = document.getElementById('results-container');
    var debounceTimer;
    var busy = false;

    function updateClearBtn() {
        var hasFilter = false;
        form.querySelectorAll('input[type=text], select').forEach(function (el) {
            if (el.value) hasFilter = true;
        });
        var btn = document.getElementById('clear-btn');
        if (btn) btn.style.display = hasFilter ? '' : 'none';
    }

    function loadUrl(url, pushState) {
        if (busy) return;
        busy = true;
        if (pushState) history.pushState(null, '', url);
        container.style.opacity = '0.4';
        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(function (r) { return r.text(); })
            .then(function (html) {
                var doc = new DOMParser().parseFromString(html, 'text/html');
                var fresh = doc.getElementById('results-container');
                if (fresh) container.innerHTML = fresh.innerHTML;
                bindPagination();
            })
            .catch(function () {})
            .finally(function () { busy = false; container.style.opacity = ''; });
    }

    function submitFilter() {
        var params = new URLSearchParams(new FormData(form));
        params.delete('page');
        loadUrl(location.pathname + '?' + params.toString(), true);
        updateClearBtn();
    }

    function bindPagination() {
        container.querySelectorAll('a.page-link').forEach(function (a) {
            a.addEventListener('click', function (e) {
                e.preventDefault();
                loadUrl(this.href, true);
            });
        });
    }

    form.querySelector('input[type=text]').addEventListener('input', function () {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(submitFilter, 400);
    });
    form.querySelectorAll('select').forEach(function (sel) {
        sel.addEventListener('change', submitFilter);
    });
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        submitFilter();
    });
    window.addEventListener('popstate', function () {
        var params = new URLSearchParams(location.search);
        form.querySelectorAll('input[type=text], select').forEach(function (el) {
            if (el.name) el.value = params.get(el.name) || '';
        });
        loadUrl(location.href, false);
        updateClearBtn();
    });

    bindPagination();
})();
</script>

<!-- Confirm modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmTitle">Confirm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="deleteConfirmBody"></div>
            <div class="modal-footer" id="deleteConfirmFooter">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteConfirmOk">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
const _csrf = '{{ csrf_token }}';
const _promotionChildRepos = {{ promotion_child_repos_json|safe }};

function showDeleteConfirm(title, body, okLabel, onOk) {
    document.getElementById('deleteConfirmTitle').textContent = title;
    document.getElementById('deleteConfirmBody').innerHTML = body;
    document.getElementById('deleteConfirmFooter').innerHTML =
        '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>' +
        `<button type="button" class="btn btn-danger" id="deleteConfirmOk">${okLabel}</button>`;
    const okBtn = document.getElementById('deleteConfirmOk');
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    okBtn.onclick = function() { modal.hide(); onOk(); };
    modal.show();
}

function showErrorModal(title, message) {
    document.getElementById('deleteConfirmTitle').textContent = title;
    document.getElementById('deleteConfirmBody').innerHTML =
        `<div class="alert alert-danger mb-0"><i class="bi bi-x-octagon-fill me-2"></i>${message}</div>`;
    document.getElementById('deleteConfirmFooter').innerHTML =
        '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>';
    const elModal = document.getElementById('deleteConfirmModal');
    (bootstrap.Modal.getInstance(elModal) || new bootstrap.Modal(elModal)).show();
}

function confirmUnpublish(buildPk, pkgName, buildRef) {
    showDeleteConfirm(
        'Unpublish Build',
        `<p>Remove <strong>${pkgName} ${buildRef}</strong> from the build repository?</p>
         <p class="text-muted small mb-0">The build record is kept and can be re-published. Existing promotions to child repositories are <strong>not</strong> affected.</p>`,
        'Unpublish',
        async () => {
            try {
                const r = await fetch(`/builds/${buildPk}/unpublish/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': _csrf },
                    credentials: 'same-origin'
                });
                const d = await r.json();
                if (r.ok) { location.reload(); }
                else { showErrorModal('Unpublish Failed', d.error || r.statusText); }
            } catch (e) { showErrorModal('Unpublish Error', e.message); }
        }
    );
}

function confirmDeletePromotion(promotionPk, pkgName, repoName) {
    const childRepos = _promotionChildRepos[String(promotionPk)] || [];
    let childWarning = '';
    if (childRepos.length > 0) {
        const repoList = childRepos.map(r => `<li>${r}</li>`).join('');
        childWarning = `
            <div class="alert alert-warning mt-2 mb-0 py-2">
                <i class="bi bi-exclamation-triangle-fill me-1"></i>
                <strong>This package is also promoted to child repositories and will be removed from those too:</strong>
                <ul class="mb-0 mt-1">${repoList}</ul>
            </div>`;
    }
    showDeleteConfirm(
        'Delete Promotion',
        `<p>Remove <strong>${pkgName}</strong> from repository <strong>${repoName}</strong>?</p>
         <p class="text-muted small mb-0">The OSTree ref will be deleted from the repository and metadata will be regenerated. This cannot be undone.</p>
         ${childWarning}`,
        'Delete',
        async () => {
            try {
                const r = await fetch(`/promotions/${promotionPk}/delete/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': _csrf },
                    credentials: 'same-origin'
                });
                const d = await r.json();
                if (r.ok) { location.reload(); }
                else { showErrorModal('Delete Failed', d.error || r.statusText); }
            } catch (e) { showErrorModal('Delete Error', e.message); }
        }
    );
}
</script>
{% endblock %}
