{% extends 'base.html' %}

{% block title %}Packages - Flat Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-box-seam"></i> Packages</h2>
    <a href="{% url 'flatpak:package_create' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> New Package
    </a>
</div>

<div class="card mb-3">
    <div class="card-body">
        <form id="filter-form" method="get" class="row g-2 align-items-end">
            <div class="col-sm-5">
                <label class="form-label small text-muted mb-1">Search</label>
                <input type="text" name="q" value="{{ filter_q }}" class="form-control form-control-sm"
                       placeholder="Package name or IDâ€¦" autocomplete="off">
            </div>
            <div class="col-sm-3">
                <label class="form-label small text-muted mb-1">Status</label>
                <select name="status" class="form-select form-select-sm">
                    <option value="">All statuses</option>
                    {% for val, label in status_choices %}
                    <option value="{{ val }}" {% if filter_status == val %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-sm-2">
                <label class="form-label small text-muted mb-1">Repository</label>
                <select name="repo" class="form-select form-select-sm">
                    <option value="">All repos</option>
                    {% for repo in repositories %}
                    <option value="{{ repo.pk }}" {% if filter_repo == repo.pk|stringformat:"s" %}selected{% endif %}>{{ repo.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto align-self-end">
                <a id="clear-btn" href="{% url 'flatpak:package_list' %}" class="btn btn-sm btn-outline-secondary"
                   {% if not filter_q and not filter_status and not filter_repo %}style="display:none"{% endif %}>
                    <i class="bi bi-x-lg"></i> Clear
                </a>
            </div>
        </form>
    </div>
</div>

<div id="results-container">
<div class="card">
    <div class="card-body">
        {% if packages %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Package ID</th>
                        <th>Repository</th>
                        <th>Status</th>
                        <th>Version</th>
                        <th>Upstream Version</th>
                        <th>Branch</th>
                        <th>Arch</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for package in packages %}
                    <tr>
                        <td>
                            <a href="{% url 'flatpak:package_detail' package.pk %}">
                                <strong>{{ package.package_name }}</strong>
                            </a>
                        </td>
                        <td><code>{{ package.package_id }}</code></td>
                        <td>
                            <a href="{% url 'flatpak:repo_detail' package.repository.pk %}">
                                {{ package.repository.name }}
                            </a>
                        </td>
                        <td>
                            {% if package.status == 'pending' %}
                            <span class="badge bg-secondary">Pending</span>
                            {% elif package.status == 'building' %}
                            <span class="badge bg-primary">Building</span>
                            {% elif package.status == 'built' %}
                            <span class="badge bg-info">Built</span>
                            {% elif package.status == 'committing' %}
                            <span class="badge bg-primary">Committing</span>
                            {% elif package.status == 'committed' %}
                            <span class="badge bg-info">Committed</span>
                            {% elif package.status == 'publishing' %}
                            <span class="badge bg-primary">Publishing</span>
                            {% elif package.status == 'published' %}
                            <span class="badge bg-success">Published</span>
                            {% elif package.status == 'failed' %}
                            <span class="badge bg-danger">Failed</span>
                            {% elif package.status == 'cancelled' %}
                            <span class="badge bg-warning">Cancelled</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ package.status }}</span>
                            {% endif %}
                        </td>
                        <td>{{ package.version|default:"-" }}</td>
                        <td>
                            {% if package.upstream_version %}
                            {{ package.upstream_version }}
                            {% if package.version and package.upstream_version != package.version %}
                            <span class="badge bg-warning text-dark ms-1"
                                  title="Newer upstream version available">
                                <i class="bi bi-arrow-up-circle"></i>
                            </span>
                            {% endif %}
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td><code>{{ package.branch }}</code></td>
                        <td>{{ package.arch }}</td>
                        <td>{{ package.created_at|date:"M d, H:i" }}</td>
                        <td>
                            <a href="{% url 'flatpak:package_detail' package.pk %}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="{% url 'flatpak:package_edit' package.pk %}" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-pencil"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if is_paginated %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mt-3">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?{% if filter_params %}{{ filter_params }}&{% endif %}page=1">First</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?{% if filter_params %}{{ filter_params }}&{% endif %}page={{ page_obj.previous_page_number }}">Previous</a>
                </li>
                {% endif %}
                <li class="page-item active">
                    <span class="page-link">
                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                    </span>
                </li>
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?{% if filter_params %}{{ filter_params }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?{% if filter_params %}{{ filter_params }}&{% endif %}page={{ page_obj.paginator.num_pages }}">Last</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}

        {% else %}
        <p class="text-muted">No packages yet. <a href="{% url 'flatpak:package_create' %}">Create your first package</a>.</p>
        {% endif %}
    </div>
</div>
</div>
<script>
(function () {
    var form = document.getElementById('filter-form');
    var container = document.getElementById('results-container');
    var debounceTimer;
    var busy = false;

    function updateClearBtn() {
        var hasFilter = false;
        form.querySelectorAll('input[type=text], select').forEach(function (el) {
            if (el.value) hasFilter = true;
        });
        var btn = document.getElementById('clear-btn');
        if (btn) btn.style.display = hasFilter ? '' : 'none';
    }

    function loadUrl(url, pushState) {
        if (busy) return;
        busy = true;
        if (pushState) history.pushState(null, '', url);
        container.style.opacity = '0.4';
        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(function (r) { return r.text(); })
            .then(function (html) {
                var doc = new DOMParser().parseFromString(html, 'text/html');
                var fresh = doc.getElementById('results-container');
                if (fresh) container.innerHTML = fresh.innerHTML;
                bindPagination();
            })
            .catch(function () {})
            .finally(function () { busy = false; container.style.opacity = ''; });
    }

    function submitFilter() {
        var params = new URLSearchParams(new FormData(form));
        params.delete('page');
        loadUrl(location.pathname + '?' + params.toString(), true);
        updateClearBtn();
    }

    function bindPagination() {
        container.querySelectorAll('a.page-link').forEach(function (a) {
            a.addEventListener('click', function (e) {
                e.preventDefault();
                loadUrl(this.href, true);
            });
        });
    }

    form.querySelector('input[type=text]').addEventListener('input', function () {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(submitFilter, 400);
    });
    form.querySelectorAll('select').forEach(function (sel) {
        sel.addEventListener('change', submitFilter);
    });
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        submitFilter();
    });
    window.addEventListener('popstate', function () {
        var params = new URLSearchParams(location.search);
        form.querySelectorAll('input[type=text], select').forEach(function (el) {
            if (el.name) el.value = params.get(el.name) || '';
        });
        loadUrl(location.href, false);
        updateClearBtn();
    });

    bindPagination();
})();
</script>
{% endblock %}
